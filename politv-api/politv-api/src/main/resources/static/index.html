<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliTV - Interactivo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- CONEXIÓN AL CSS -->
    <link rel="stylesheet" href="index.css">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

    <div class="app-container">
        
        <!-- SIDEBAR IZQUIERDA -->
        <nav class="sidebar-left">
            <div class="logo-area">
                <i class="bi bi-play-circle-fill text-danger fs-2"></i>
                <h4 class="mb-0 fw-bold ms-2 text-white">PoliTV</h4>
            </div>

            <a href="#" onclick="mostrarHome()" class="nav-item active" id="navHome"><i class="bi bi-house-door-fill"></i> Para Ti</a>
            <a href="#" class="nav-item"><i class="bi bi-search"></i> Buscar</a>
            <a href="#" class="nav-item"><i class="bi bi-calendar-check"></i> Calendario</a>

            <div class="section-header">Favoritos</div>
            <div id="listaFavoritos">
                <a href="#" onclick="abrirPrograma(3, 'Bendita TV')" class="nav-item"><i class="bi bi-tv"></i> Bendita</a>
                <a href="#" onclick="abrirPrograma(1, 'Cortá por Lozano')" class="nav-item"><i class="bi bi-tv"></i> Cortá por Lozano</a>
                <a href="#" onclick="abrirPrograma(2, 'Telefe Noticias')" class="nav-item"><i class="bi bi-tv"></i> Telefe Noticias</a>
                <a href="#" onclick="abrirPrograma(4, 'Nadie Dice Nada')" class="nav-item"><i class="bi bi-mic"></i> Nadie Dice Nada</a>
                <a href="#" onclick="abrirPrograma(5, 'Gelatina')" class="nav-item"><i class="bi bi-mic"></i> Gelatina</a>
            </div>

            <div class="section-header">Recursos</div>
            <a href="#" class="nav-item"><i class="bi bi-person-circle"></i> Perfil</a>
            <a href="#" class="nav-item"><i class="bi bi-gear"></i> Configuración</a>
        </nav>


        <!-- CONTENIDO CENTRAL -->
        <main class="main-content">
            
            <div class="top-navbar">
                <div class="d-flex align-items-center gap-3">
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <span class="input-group-text bg-dark text-white border-secondary">ID User</span>
                        <input type="number" id="inputUserId" class="form-control bg-dark text-white border-secondary" value="1">
                    </div>
                    <button class="btn btn-sm btn-danger rounded-pill px-3">INICIAR SESION</button>
                    <button class="btn btn-sm btn-light rounded-pill px-3">REGISTRARSE</button>
                </div>
            </div>

            <div class="scrollable-content">
                
                <!-- VISTA HOME (Feed General) -->
                <div id="viewHome">
                    <h1 class="fw-bold mb-4">Bienvenido, <span id="userNameDisplay">Usuario</span></h1>
                    <div class="red-line-divider"></div>
                    
                    <h3 class="mb-4">Últimas Publicaciones</h3>
                    <div id="feedGeneralContainer">
                        <div class="text-center text-muted">Cargando todas las novedades...</div>
                    </div>
                </div>

                <!-- VISTA PROGRAMA ESPECÍFICO -->
                <div id="viewProgram" style="display: none;">
                    
                    <div class="program-hero active">
                        <img src="https://picsum.photos/800/300" class="hero-bg" alt="Cover">
                        <div class="hero-overlay">
                            <img src="" id="imgProgramaAvatar" class="program-avatar-lg">
                            <div>
                                <h2 class="fw-bold mb-0 text-white" id="txtProgramaTitulo">Nombre Programa</h2>
                                <p class="text-white-50 mb-0 small">@cuenta_oficial <i class="bi bi-patch-check-fill text-primary"></i></p>
                            </div>
                        </div>
                    </div>

                    <h3 class="fw-bold mt-4">Muro del Programa</h3>
                    <div class="red-line-divider"></div>

                    <button class="fab-btn" onclick="abrirModalPost()" title="Comentar">
                        <i class="bi bi-plus-lg"></i>
                    </button>

                    <div id="feedContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-danger" role="status"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>


        <!-- SIDEBAR DERECHA -->
        <aside class="sidebar-right">
            
            <!-- LISTA COMUNIDADES (Se ve en Home) -->
            <div id="rightHome" style="display: flex; flex-direction: column; height: 100%;">
                <div class="right-title">Comunidades en Vivo</div>
                
                <div class="community-list-container">
                    <div class="community-item" onclick="abrirPrograma(3, 'Bendita TV')">
                        <img src="https://ui-avatars.com/api/?name=B&background=random" class="comm-avatar">
                        <span>Bendita</span>
                        <i class="bi bi-broadcast comm-icon"></i>
                    </div>
                    <div class="community-item" onclick="abrirPrograma(2, 'Telefe Noticias')">
                        <img src="https://ui-avatars.com/api/?name=T&background=random" class="comm-avatar">
                        <span>Telefe Noticias</span>
                        <i class="bi bi-broadcast comm-icon"></i>
                    </div>
                    <div class="community-item" onclick="abrirPrograma(4, 'Nadie Dice Nada')">
                        <img src="https://ui-avatars.com/api/?name=L&background=random" class="comm-avatar">
                        <span>Luzu TV</span>
                        <i class="bi bi-broadcast comm-icon"></i>
                    </div>
                </div>

                <div class="vip-card mt-auto">
                    <h5 class="text-red mb-1">Suscribite Vip</h5>
                    <p class="small text-muted mb-2">Obtén beneficios y sin anuncios.</p>
                    <button class="btn-vip">Suscribirse Vip</button>
                </div>
            </div>

            <!-- CHAT (Se ve en Programa) -->
            <div id="rightChat" class="chat-container">
                <div class="right-title d-flex justify-content-between">
                    Chat en Vivo
                    <span class="badge bg-success" id="statusBadge" style="font-size: 0.6rem; align-self: center;">ONLINE</span>
                </div>

                <div class="chat-history" id="chatBox">
                    <!-- Mensajes -->
                </div>

                <div class="chat-input-area mt-auto">
                    <input type="text" id="chatMsgInput" class="form-control form-control-sm chat-input" placeholder="Enviar mensaje...">
                    <button class="btn btn-sm btn-danger" onclick="enviarMensaje()"><i class="bi bi-send-fill"></i></button>
                </div>
            </div>

        </aside>

    </div>

    <!-- MODAL NUEVA PUBLICACIÓN -->
    <div class="modal fade" id="modalPost" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-dark">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nueva Publicación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="txtContenidoPost" class="form-control form-control-dark" rows="3" placeholder="Escribe tu opinión sobre el programa..."></textarea>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmarPublicacion()">Publicar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        const SOCKET_URL = 'http://localhost:8080/chat-websocket';
        
        let programaActual = null;
        let stompClient = null;

        // Cargar feed general al inicio
        document.addEventListener('DOMContentLoaded', () => {
            mostrarHome();
        });

        // --- NAVEGACIÓN ---
        function mostrarHome() {
            programaActual = null;
            
            // 1. Visibilidad Paneles Centrales
            document.getElementById('viewHome').style.display = 'block';
            document.getElementById('viewProgram').style.display = 'none';
            
            // 2. Visibilidad Sidebar Derecha (FIX)
            document.getElementById('rightHome').style.display = 'flex'; // Restaurar Flex
            document.getElementById('rightChat').classList.remove('active');
            
            // 3. Desconectar Chat
            if(stompClient) stompClient.disconnect();
            
            // 4. UI Nav Activa
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('navHome').classList.add('active');

            // 5. Cargar Feed General
            cargarFeedHome();
        }

        function abrirPrograma(id, titulo) {
            programaActual = id;
            
            // 1. Visibilidad Paneles
            document.getElementById('viewHome').style.display = 'none';
            document.getElementById('viewProgram').style.display = 'block';
            
            // 2. Switch Sidebar Derecha
            document.getElementById('rightHome').style.display = 'none'; // Ocultar comunidades
            document.getElementById('rightChat').classList.add('active'); // Mostrar Chat

            // 3. Info Header
            document.getElementById('txtProgramaTitulo').innerText = titulo;
            document.getElementById('imgProgramaAvatar').src = `https://ui-avatars.com/api/?name=${titulo}&background=random&size=128`;

            // 4. Cargas
            cargarMuro(id, 'feedContainer');
            iniciarChat(id);
        }

        // --- LÓGICA DE DATOS ---

        // Función para cargar muro de un programa específico
        async function cargarMuro(id, containerId) {
            const contenedor = document.getElementById(containerId);
            contenedor.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-danger"></div></div>';

            try {
                const res = await fetch(`${API_BASE}/programas/${id}/blog/comentarios`);
                if(!res.ok) throw new Error("Error API");
                const posts = await res.json();
                renderPosts(posts, contenedor);
            } catch (e) {
                console.error(e);
                contenedor.innerHTML = '<div class="alert alert-dark border-secondary">Sin conexión con el servidor.</div>';
            }
        }

        // Función especial para el HOME que carga TODOS los programas (1-5)
        async function cargarFeedHome() {
            const contenedor = document.getElementById('feedGeneralContainer');
            contenedor.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-danger"></div></div>';
            
            let allPosts = [];
            // IDs de programas conocidos en tu BDD
            const programIds = [1, 2, 3, 4, 5];

            try {
                // Hacer peticiones en paralelo
                const promises = programIds.map(id => 
                    fetch(`${API_BASE}/programas/${id}/blog/comentarios`)
                        .then(res => res.ok ? res.json() : [])
                        .catch(() => [])
                );

                const results = await Promise.all(promises);
                
                // Unir todos los arrays
                results.forEach(posts => {
                    allPosts = [...allPosts, ...posts];
                });

                // (Opcional) Ordenar o mezclar si tuvieran fecha real
                // allPosts.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));

                if(allPosts.length === 0) {
                    contenedor.innerHTML = '<div class="text-center text-muted py-4">No hay publicaciones recientes en la red.</div>';
                } else {
                    renderPosts(allPosts, contenedor);
                }

            } catch (e) {
                console.error("Error feed home", e);
                contenedor.innerHTML = '<div class="text-center text-danger">Error cargando el feed general.</div>';
            }
        }

        function renderPosts(posts, contenedor) {
            contenedor.innerHTML = '';
            posts.forEach(p => {
                const html = `
                    <div class="post-card">
                        <div class="post-header">
                            <img src="https://ui-avatars.com/api/?name=User&background=333&color=fff" class="user-avatar">
                            <div>
                                <h6 class="mb-0 fw-bold text-white">Usuario ${p.usuarioId} <i class="bi bi-patch-check-fill text-primary small"></i></h6>
                                <small class="text-muted">Publicado en Programa ${p.programaId || '?'}</small>
                            </div>
                        </div>
                        <p class="mb-2 post-text">${p.contenido || p.texto || ''}</p>
                        <div class="d-flex gap-3 text-muted small">
                            <span><i class="bi bi-heart"></i> ${p.likes || 0}</span>
                            <span><i class="bi bi-chat"></i> Responder</span>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += html;
            });
        }

        // --- POSTEAR ---
        function abrirModalPost() {
            const modal = new bootstrap.Modal(document.getElementById('modalPost'));
            modal.show();
        }

        async function confirmarPublicacion() {
            const texto = document.getElementById('txtContenidoPost').value;
            const uid = document.getElementById('inputUserId').value;
            if(!texto.trim()) return;

            try {
                const params = new URLSearchParams();
                params.append('usuarioId', uid);
                params.append('contenido', texto);

                const res = await fetch(`${API_BASE}/programas/${programaActual}/blog/comentar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                });

                if(res.ok) {
                    const modalEl = document.getElementById('modalPost');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    document.getElementById('txtContenidoPost').value = '';
                    cargarMuro(programaActual, 'feedContainer');
                } else {
                    alert('Error al publicar');
                }
            } catch(e) { console.error(e); }
        }

        // --- CHAT ---
        function iniciarChat(progId) {
            if(stompClient) stompClient.disconnect();
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('statusBadge').className = 'badge bg-warning';
            document.getElementById('statusBadge').innerText = '...';

            fetch(`${API_BASE}/chat/historial/${progId}`)
                .then(r => r.json())
                .then(msgs => msgs.forEach(agregarBurbujaChat))
                .catch(e => console.log("Sin historial"));

            const socket = new SockJS(SOCKET_URL);
            stompClient = Stomp.over(socket);
            stompClient.debug = null; 

            stompClient.connect({}, frame => {
                document.getElementById('statusBadge').className = 'badge bg-success';
                document.getElementById('statusBadge').innerText = 'EN VIVO';

                stompClient.subscribe(`/topic/chat/${progId}`, msg => {
                    agregarBurbujaChat(JSON.parse(msg.body));
                });
            });
        }

        function enviarMensaje() {
            const input = document.getElementById('chatMsgInput');
            const txt = input.value.trim();
            const uid = document.getElementById('inputUserId').value;

            if(txt && stompClient && programaActual) {
                const payload = {
                    usuarioId: parseInt(uid),
                    programaId: parseInt(programaActual),
                    mensaje: txt
                };
                stompClient.send(`/app/chat/${programaActual}`, {}, JSON.stringify(payload));
                input.value = '';
            }
        }

        function agregarBurbujaChat(msg) {
            const box = document.getElementById('chatBox');
            const uid = document.getElementById('inputUserId').value;
            const esMio = msg.usuarioId.toString() === uid.toString();
            const div = document.createElement('div');
            div.className = `chat-bubble ${esMio ? 'mine' : ''}`;
            div.innerHTML = `<span class="chat-user-name">${msg.nombreUsuario || 'Usuario'}</span>${msg.mensaje}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
        
        document.getElementById('chatMsgInput').addEventListener('keyup', e => {
            if(e.key === 'Enter') enviarMensaje();
        });
    </script>
</body>
</html>